<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人中心 - Influencer Promotion Platform</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .profile-layout {
            max-width: 1180px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 18px;
        }

        .card {
            background: #fff;
            border-radius: 14px;
            border: 1px solid #d8e5f1;
            box-shadow: 0 8px 22px rgba(16, 37, 57, 0.08);
        }

        .user-card {
            padding: 20px;
        }

        .avatar {
            width: 86px;
            height: 86px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0f9b8e, #2f79bb);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            margin: 0 auto 12px;
        }

        .user-name { text-align: center; font-size: 20px; font-weight: 700; color: #102335; }
        .user-role { text-align: center; color: #5f7086; font-size: 14px; margin-bottom: 18px; }
        .user-meta { font-size: 13px; color: #5f7086; line-height: 1.8; }

        .tab-nav {
            margin-top: 18px;
            display: grid;
            gap: 8px;
        }

        .tab-btn {
            width: 100%;
            border: 1px solid #d4e1ee;
            border-radius: 10px;
            background: #fff;
            text-align: left;
            padding: 10px 12px;
            font-weight: 700;
            color: #32465c;
            cursor: pointer;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #0f9b8e, #2f79bb);
            border-color: transparent;
            color: #ffffff;
            box-shadow: 0 10px 22px rgba(12, 124, 114, 0.3);
        }

        .content-card {
            padding: 20px;
        }

        .section-title {
            margin: 0 0 14px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5ecf3;
            color: #102335;
            font-size: 20px;
        }

        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }

        .form-group { margin-bottom: 12px; }
        .form-group textarea {
            min-height: 90px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }

        .social-list {
            margin-top: 14px;
            display: grid;
            gap: 10px;
        }

        .social-item {
            border: 1px solid #dbe7f2;
            border-radius: 10px;
            background: #f8fbff;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .social-main {
            flex: 1;
            min-width: 220px;
        }
        .social-main h4 {
            margin: 0 0 6px;
            color: #102335;
            font-size: 15px;
        }
        .social-main p {
            margin: 0;
            color: #5f7086;
            font-size: 13px;
            line-height: 1.6;
        }

        .social-actions {
            display: flex;
            gap: 8px;
        }

        .history-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: grid;
            gap: 10px;
        }

        .history-item {
            border: 1px solid #dbe7f2;
            border-radius: 10px;
            background: #f8fbff;
            padding: 12px;
        }

        .history-item h4 {
            margin: 0 0 4px;
            color: #102335;
            font-size: 15px;
        }

        .history-item p {
            margin: 0;
            color: #5f7086;
            font-size: 13px;
            line-height: 1.6;
        }

        .history-time {
            margin-top: 6px;
            color: #999;
            font-size: 12px;
        }

        .method-panel {
            border: 1px solid #dbe7f2;
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
            display: none;
            background: #f7fbff;
        }

        .method-panel.active {
            display: block;
        }

        .method-description {
            margin: 0 0 10px;
            color: #4e6178;
            font-size: 13px;
            line-height: 1.7;
        }

        @media (max-width: 960px) {
            .profile-layout { grid-template-columns: 1fr; }
            .form-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 720px) {
            .form-actions {
                flex-direction: column;
            }

            .form-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body class="user-body">
<div class="app-shell">
<button class="mobile-nav-toggle" type="button" data-nav-toggle aria-label="打开导航菜单">
    <i class="fas fa-bars"></i>
</button>

<aside class="sidebar">
    <div class="sidebar-header">
        <h2>Influencer Platform</h2>
    </div>
    <ul class="sidebar-nav">
        <li><a href="/dashboard"><i class="fas fa-tachometer-alt"></i>仪表盘</a></li>
        <li><a href="/tasks"><i class="fas fa-tasks"></i>任务</a></li>
        <li><a href="/assignments"><i class="fas fa-clipboard-list"></i>我的任务</a></li>
        <li><a href="/profile" class="active"><i class="fas fa-user"></i>个人资料</a></li>
        <li><a href="/login" id="logout-link"><i class="fas fa-sign-out-alt"></i>退出登录</a></li>
    </ul>
</aside>

<div class="sidebar-overlay" data-nav-overlay></div>

<main class="main-content">
    <div class="profile-layout">
        <div class="card user-card">
            <div class="avatar" id="profile-avatar">?</div>
            <div class="user-name" id="profile-name">-</div>
            <div class="user-role" id="profile-role">-</div>
            <div class="user-meta">
                <div>账号: <span id="profile-username">-</span></div>
                <div>邮箱: <span id="profile-email">-</span></div>
                <div>审核状态: <span id="profile-review">-</span></div>
            </div>

            <div class="tab-nav" id="tab-nav">
                <button class="tab-btn active" data-tab="basic">个人信息</button>
                <button class="tab-btn" data-tab="social">我的社交与自媒体平台</button>
                <button class="tab-btn" data-tab="security">账号安全</button>
                <button class="tab-btn" data-tab="payout">收款信息</button>
                <button class="tab-btn" data-tab="history">历史记录</button>
            </div>
        </div>

        <div class="card content-card">
            <div id="alert" class="alert"></div>

            <section class="tab-panel active" id="panel-basic">
                <h2 class="section-title">个人信息</h2>
                <form id="basic-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="basic-username">用户名</label>
                            <input id="basic-username" disabled>
                        </div>
                        <div class="form-group">
                            <label for="basic-email">邮箱</label>
                            <input id="basic-email" disabled>
                        </div>
                        <div class="form-group">
                            <label for="basic-phone">手机号</label>
                            <input id="basic-phone" disabled>
                        </div>
                        <div class="form-group">
                            <label for="basic-display-name">展示名</label>
                            <input id="basic-display-name">
                        </div>
                        <div class="form-group">
                            <label for="basic-real-name">真实姓名</label>
                            <input id="basic-real-name">
                        </div>
                        <div class="form-group">
                            <label for="basic-id-no">身份证号</label>
                            <input id="basic-id-no">
                        </div>
                        <div class="form-group">
                            <label for="basic-city">城市</label>
                            <input id="basic-city">
                        </div>
                        <div class="form-group">
                            <label for="basic-category">内容领域</label>
                            <input id="basic-category">
                        </div>
                        <div class="form-group">
                            <label for="basic-follower-total">粉丝总量</label>
                            <input id="basic-follower-total" type="number" min="0">
                        </div>
                        <div class="form-group">
                            <label for="basic-avg-views">平均播放量</label>
                            <input id="basic-avg-views" type="number" min="0">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="basic-tags">标签（逗号分隔）</label>
                        <input id="basic-tags" placeholder="beauty,short-video,live">
                    </div>

                    <div class="form-actions">
                        <button class="btn btn-primary" type="submit">保存个人信息</button>
                    </div>
                </form>
            </section>

            <section class="tab-panel" id="panel-social">
                <h2 class="section-title">我的社交与自媒体平台</h2>
                <form id="social-form">
                    <input type="hidden" id="social-edit-id">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="social-platform">平台</label>
                            <select id="social-platform" required>
                                <option value="douyin">抖音</option>
                                <option value="xiaohongshu">小红书</option>
                                <option value="weibo">微博</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="social-account-name">账号名称</label>
                            <input id="social-account-name" required>
                        </div>
                        <div class="form-group">
                            <label for="social-account-id">账号ID</label>
                            <input id="social-account-id" required>
                        </div>
                        <div class="form-group">
                            <label for="social-follower-count">粉丝量</label>
                            <input id="social-follower-count" type="number" min="0" value="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="social-profile-url">主页链接</label>
                        <input id="social-profile-url" type="url" placeholder="https://...">
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" type="submit" id="social-submit-btn">添加账号</button>
                        <button class="btn btn-outline" type="button" id="social-cancel-edit" style="display:none;">取消编辑</button>
                    </div>
                </form>

                <div id="social-list" class="social-list"></div>
            </section>

            <section class="tab-panel" id="panel-security">
                <h2 class="section-title">账号安全</h2>
                <form id="password-form">
                    <div class="form-group">
                        <label for="password-current">当前密码</label>
                        <input id="password-current" type="password" required>
                    </div>
                    <div class="form-group">
                        <label for="password-new">新密码（至少 8 位）</label>
                        <input id="password-new" type="password" minlength="8" required>
                    </div>
                    <div class="form-group">
                        <label for="password-confirm">确认新密码</label>
                        <input id="password-confirm" type="password" minlength="8" required>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" type="submit">更新密码</button>
                    </div>
                </form>
            </section>

            <section class="tab-panel" id="panel-payout">
                <h2 class="section-title">收款信息</h2>
                <form id="payout-form">
                    <div class="form-group">
                        <label for="payout-method">首选收款方式</label>
                        <select id="payout-method" required>
                            <option value="bank_card">银行卡</option>
                            <option value="wechat_pay">微信支付</option>
                            <option value="alipay">支付宝</option>
                        </select>
                    </div>

                    <div class="method-panel" id="panel-payout-bank">
                        <p class="method-description">
                            银行卡结算说明：请确保实名信息准确，放款前站长会线下确认打款账户信息并完成转账。
                        </p>
                        <div class="form-group">
                            <label for="payout-bank-description">补充说明（可选）</label>
                            <textarea id="payout-bank-description" placeholder="可填写开户行或其他说明"></textarea>
                        </div>
                    </div>

                    <div class="method-panel" id="panel-payout-wechat">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="payout-wechat-id">微信号</label>
                                <input id="payout-wechat-id" placeholder="请输入微信号">
                            </div>
                            <div class="form-group">
                                <label for="payout-wechat-phone">手机号</label>
                                <input id="payout-wechat-phone" placeholder="请输入微信绑定手机号">
                            </div>
                        </div>
                        <input type="hidden" id="payout-wechat-qr-url">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="payout-wechat-qr-file">微信收款码</label>
                                <input id="payout-wechat-qr-file" type="file" accept="image/*">
                            </div>
                            <div class="form-group">
                                <label for="payout-wechat-qr-preview">收款码 OSS 地址</label>
                                <input id="payout-wechat-qr-preview" disabled placeholder="上传后自动生成">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-outline" type="button" id="upload-wechat-qr-btn">上传微信收款码</button>
                        </div>
                    </div>

                    <div class="method-panel" id="panel-payout-alipay">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="payout-alipay-phone">手机号</label>
                                <input id="payout-alipay-phone" placeholder="请输入支付宝绑定手机号">
                            </div>
                            <div class="form-group">
                                <label for="payout-alipay-name">收款人姓名</label>
                                <input id="payout-alipay-name" placeholder="请输入收款人姓名">
                            </div>
                        </div>
                        <input type="hidden" id="payout-alipay-qr-url">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="payout-alipay-qr-file">支付宝收款码</label>
                                <input id="payout-alipay-qr-file" type="file" accept="image/*">
                            </div>
                            <div class="form-group">
                                <label for="payout-alipay-qr-preview">收款码 OSS 地址</label>
                                <input id="payout-alipay-qr-preview" disabled placeholder="上传后自动生成">
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-outline" type="button" id="upload-alipay-qr-btn">上传支付宝收款码</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="payout-note">备注</label>
                        <textarea id="payout-note"></textarea>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-primary" type="submit">保存收款信息</button>
                    </div>
                </form>
            </section>

            <section class="tab-panel" id="panel-history">
                <h2 class="section-title">历史记录</h2>
                <ul id="history-list" class="history-list"></ul>
            </section>
        </div>
    </div>
</main>
</div>

<script src="/static/js/client.js"></script>
<script src="/static/js/user-layout.js"></script>
<script>
    let currentUser = null;
    let socialAccounts = [];
    let historyRecords = [];

    function showAlert(message, type = "error") {
        const alert = document.getElementById("alert");
        alert.textContent = message;
        alert.className = `alert ${type}`;
        alert.style.display = "block";
    }

    function clearAlert() {
        const alert = document.getElementById("alert");
        alert.style.display = "none";
    }

    function reviewLabel(status) {
        const map = {
            pending: "待审核",
            under_review: "审核中",
            approved: "已通过",
            rejected: "已拒绝",
        };
        return map[status] || status || "-";
    }

    function setUserCard(user) {
        const displayName = user.display_name || user.username || "-";
        document.getElementById("profile-name").textContent = displayName;
        document.getElementById("profile-role").textContent = roleLabel(user.role);
        document.getElementById("profile-username").textContent = user.username || "-";
        document.getElementById("profile-email").textContent = user.email || "-";
        document.getElementById("profile-review").textContent = reviewLabel(user.review_status);
        document.getElementById("profile-avatar").textContent = displayName.slice(0, 1).toUpperCase() || "?";
    }

    function fillBasicForm(user) {
        document.getElementById("basic-username").value = user.username || "";
        document.getElementById("basic-email").value = user.email || "";
        document.getElementById("basic-phone").value = user.phone || "";
        document.getElementById("basic-display-name").value = user.display_name || "";
        document.getElementById("basic-real-name").value = user.real_name || "";
        document.getElementById("basic-id-no").value = user.id_no || "";
        document.getElementById("basic-city").value = user.city || "";
        document.getElementById("basic-category").value = user.category || "";
        document.getElementById("basic-follower-total").value = user.follower_total || 0;
        document.getElementById("basic-avg-views").value = user.avg_views || 0;
        document.getElementById("basic-tags").value = (user.tags || []).join(",");
    }

    function resetSocialForm() {
        document.getElementById("social-edit-id").value = "";
        document.getElementById("social-platform").disabled = false;
        document.getElementById("social-platform").value = "douyin";
        document.getElementById("social-account-name").value = "";
        document.getElementById("social-account-id").value = "";
        document.getElementById("social-profile-url").value = "";
        document.getElementById("social-follower-count").value = 0;
        document.getElementById("social-submit-btn").textContent = "添加账号";
        document.getElementById("social-cancel-edit").style.display = "none";
    }

    function fillSocialForm(account) {
        document.getElementById("social-edit-id").value = account.id;
        document.getElementById("social-platform").value = account.platform;
        document.getElementById("social-platform").disabled = true;
        document.getElementById("social-account-name").value = account.account_name || "";
        document.getElementById("social-account-id").value = account.account_id || "";
        document.getElementById("social-profile-url").value = account.profile_url || "";
        document.getElementById("social-follower-count").value = account.follower_count || 0;
        document.getElementById("social-submit-btn").textContent = "保存修改";
        document.getElementById("social-cancel-edit").style.display = "inline-block";
    }

    function renderSocialList() {
        const container = document.getElementById("social-list");
        if (!socialAccounts.length) {
            container.innerHTML = '<div class="social-item"><div class="social-main"><h4>暂无账号</h4><p>请先添加至少一个社交/自媒体账号</p></div></div>';
            return;
        }

        container.innerHTML = socialAccounts.map((account) => `
            <div class="social-item">
                <div class="social-main">
                    <h4>${escapeHtml(platformLabel(account.platform))} | ${escapeHtml(account.account_name)}</h4>
                    <p>账号ID: ${escapeHtml(account.account_id)} | 粉丝: ${Number(account.follower_count || 0).toLocaleString("zh-CN")}</p>
                    <p>主页: ${escapeHtml(account.profile_url || "-")}</p>
                </div>
                <div class="social-actions">
                    <button class="btn btn-outline" data-action="edit" data-id="${account.id}">编辑</button>
                    <button class="btn btn-danger" data-action="delete" data-id="${account.id}">删除</button>
                </div>
            </div>
        `).join("");
    }

    function togglePayoutPanels(method) {
        const normalized = method || "bank_card";
        document.querySelectorAll("#panel-payout .method-panel").forEach((panel) => panel.classList.remove("active"));
        if (normalized === "wechat_pay") {
            document.getElementById("panel-payout-wechat").classList.add("active");
            return;
        }
        if (normalized === "alipay") {
            document.getElementById("panel-payout-alipay").classList.add("active");
            return;
        }
        document.getElementById("panel-payout-bank").classList.add("active");
    }

    function fillPayout(payout) {
        const method = payout?.payout_method || "bank_card";
        document.getElementById("payout-method").value = method;

        document.getElementById("payout-bank-description").value = payout?.bank_description || "";

        document.getElementById("payout-wechat-id").value = payout?.wechat_id || "";
        document.getElementById("payout-wechat-phone").value = payout?.wechat_phone || "";
        document.getElementById("payout-wechat-qr-url").value = payout?.wechat_qr_url || "";
        document.getElementById("payout-wechat-qr-preview").value = payout?.wechat_qr_url || "";

        document.getElementById("payout-alipay-phone").value = payout?.alipay_phone || "";
        document.getElementById("payout-alipay-name").value = payout?.alipay_account_name || "";
        document.getElementById("payout-alipay-qr-url").value = payout?.alipay_qr_url || "";
        document.getElementById("payout-alipay-qr-preview").value = payout?.alipay_qr_url || "";

        document.getElementById("payout-note").value = payout?.note || "";
        togglePayoutPanels(method);
    }

    function collectPayoutPayload() {
        const method = document.getElementById("payout-method").value;
        const payload = {
            payout_method: method,
            bank_description: document.getElementById("payout-bank-description").value.trim() || null,
            wechat_id: document.getElementById("payout-wechat-id").value.trim() || null,
            wechat_phone: document.getElementById("payout-wechat-phone").value.trim() || null,
            wechat_qr_url: document.getElementById("payout-wechat-qr-url").value.trim() || null,
            alipay_phone: document.getElementById("payout-alipay-phone").value.trim() || null,
            alipay_account_name: document.getElementById("payout-alipay-name").value.trim() || null,
            alipay_qr_url: document.getElementById("payout-alipay-qr-url").value.trim() || null,
            note: document.getElementById("payout-note").value.trim() || null,
        };

        if (method === "wechat_pay") {
            if (!payload.wechat_id || !payload.wechat_phone) {
                throw new Error("微信收款方式需填写微信号和手机号");
            }
            if (!payload.wechat_qr_url) {
                throw new Error("请先上传微信收款码");
            }
        }

        if (method === "alipay") {
            if (!payload.alipay_phone || !payload.alipay_account_name) {
                throw new Error("支付宝收款方式需填写手机号和收款人姓名");
            }
            if (!payload.alipay_qr_url) {
                throw new Error("请先上传支付宝收款码");
            }
        }

        return payload;
    }

    async function uploadPayoutQr(method) {
        const isWechat = method === "wechat_pay";
        const fileInput = document.getElementById(isWechat ? "payout-wechat-qr-file" : "payout-alipay-qr-file");
        const previewInput = document.getElementById(isWechat ? "payout-wechat-qr-preview" : "payout-alipay-qr-preview");
        const hiddenInput = document.getElementById(isWechat ? "payout-wechat-qr-url" : "payout-alipay-qr-url");
        const button = document.getElementById(isWechat ? "upload-wechat-qr-btn" : "upload-alipay-qr-btn");
        const file = fileInput.files && fileInput.files[0];
        if (!file) {
            throw new Error("请选择收款码图片后再上传");
        }

        button.disabled = true;
        const originLabel = button.textContent;
        button.textContent = "上传中...";

        try {
            const formData = new FormData();
            formData.append("file", file);
            const result = await apiRequest(`/users/me/payout-info/qrcode?method=${encodeURIComponent(method)}`, {
                method: "POST",
                body: formData,
            });
            hiddenInput.value = result.url || "";
            previewInput.value = result.url || "";
            showAlert("收款码上传成功", "success");
        } finally {
            button.disabled = false;
            button.textContent = originLabel;
        }
    }

    function renderHistory() {
        const list = document.getElementById("history-list");
        if (!historyRecords.length) {
            list.innerHTML = "<li class='history-item'><h4>暂无记录</h4><p>近期没有可展示的操作历史</p></li>";
            return;
        }

        list.innerHTML = historyRecords.map((item) => `
            <li class="history-item">
                <h4>${escapeHtml(item.title || "操作记录")}</h4>
                <p>${escapeHtml(item.detail || "-")}</p>
                <div class="history-time">${escapeHtml(formatDateTime(item.created_at))}</div>
            </li>
        `).join("");
    }

    function collectBasicPayload() {
        return {
            display_name: document.getElementById("basic-display-name").value.trim() || null,
            real_name: document.getElementById("basic-real-name").value.trim() || null,
            id_no: document.getElementById("basic-id-no").value.trim() || null,
            city: document.getElementById("basic-city").value.trim() || null,
            category: document.getElementById("basic-category").value.trim() || null,
            tags: document.getElementById("basic-tags").value
                .split(",")
                .map((item) => item.trim())
                .filter(Boolean),
            follower_total: Number(document.getElementById("basic-follower-total").value || 0),
            avg_views: Number(document.getElementById("basic-avg-views").value || 0),
        };
    }

    async function refreshAll() {
        const [user, accounts, payout, history] = await Promise.all([
            apiRequest("/users/me"),
            apiRequest("/users/me/social-accounts"),
            apiRequest("/users/me/payout-info"),
            apiRequest("/users/me/history?limit=100"),
        ]);

        currentUser = user;
        socialAccounts = accounts || [];
        historyRecords = history || [];

        setUserCard(user);
        fillBasicForm(user);
        renderSocialList();
        fillPayout(payout);
        renderHistory();
    }

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            await requireUserWithRoles(["blogger"]);
        } catch (error) {
            showAlert(error.message || "页面权限校验失败");
            return;
        }

        document.getElementById("logout-link").addEventListener("click", () => {
            clearAuth();
        });

        document.getElementById("tab-nav").addEventListener("click", (event) => {
            const button = event.target.closest("button[data-tab]");
            if (!button) return;

            document.querySelectorAll("#tab-nav .tab-btn").forEach((item) => item.classList.remove("active"));
            button.classList.add("active");

            const target = button.dataset.tab;
            document.querySelectorAll(".tab-panel").forEach((panel) => panel.classList.remove("active"));
            document.getElementById(`panel-${target}`).classList.add("active");
        });

        document.getElementById("basic-form").addEventListener("submit", async (event) => {
            event.preventDefault();
            clearAlert();
            try {
                await apiRequest("/users/me/profile", {
                    method: "PATCH",
                    body: collectBasicPayload(),
                });
                await refreshAll();
                showAlert("个人信息已更新", "success");
            } catch (error) {
                showAlert(error.message || "更新个人信息失败");
            }
        });

        document.getElementById("social-form").addEventListener("submit", async (event) => {
            event.preventDefault();
            clearAlert();

            const editId = document.getElementById("social-edit-id").value;
            const platform = document.getElementById("social-platform").value;
            const payload = {
                account_name: document.getElementById("social-account-name").value.trim(),
                account_id: document.getElementById("social-account-id").value.trim(),
                profile_url: document.getElementById("social-profile-url").value.trim() || null,
                follower_count: Number(document.getElementById("social-follower-count").value || 0),
            };

            try {
                if (editId) {
                    await apiRequest(`/users/me/accounts/${platform}/${Number(editId)}`, {
                        method: "PATCH",
                        body: payload,
                    });
                    showAlert("账号已更新", "success");
                } else {
                    await apiRequest(`/users/me/accounts/${platform}`, {
                        method: "POST",
                        body: payload,
                    });
                    showAlert("账号已添加", "success");
                }
                await refreshAll();
                resetSocialForm();
            } catch (error) {
                showAlert(error.message || "保存账号失败");
            }
        });

        document.getElementById("social-cancel-edit").addEventListener("click", () => {
            resetSocialForm();
        });

        document.getElementById("social-list").addEventListener("click", async (event) => {
            const button = event.target.closest("button[data-action]");
            if (!button) return;

            const id = Number(button.dataset.id);
            const account = socialAccounts.find((item) => item.id === id);
            if (!account) return;

            if (button.dataset.action === "edit") {
                fillSocialForm(account);
                return;
            }

            if (button.dataset.action === "delete") {
                if (!window.confirm(`确认删除 ${platformLabel(account.platform)} 账号 ${account.account_name} ?`)) {
                    return;
                }
                clearAlert();
                try {
                    await apiRequest(`/users/me/accounts/${account.platform}/${account.id}`, {
                        method: "DELETE",
                    });
                    await refreshAll();
                    resetSocialForm();
                    showAlert("账号已删除", "success");
                } catch (error) {
                    showAlert(error.message || "删除账号失败");
                }
            }
        });

        document.getElementById("password-form").addEventListener("submit", async (event) => {
            event.preventDefault();
            clearAlert();

            const currentPassword = document.getElementById("password-current").value;
            const newPassword = document.getElementById("password-new").value;
            const confirmPassword = document.getElementById("password-confirm").value;

            if (newPassword !== confirmPassword) {
                showAlert("两次输入的新密码不一致");
                return;
            }

            try {
                await apiRequest("/users/me/change-password", {
                    method: "POST",
                    body: {
                        current_password: currentPassword,
                        new_password: newPassword,
                    },
                });
                document.getElementById("password-form").reset();
                await refreshAll();
                showAlert("密码已更新", "success");
            } catch (error) {
                showAlert(error.message || "更新密码失败");
            }
        });

        document.getElementById("payout-method").addEventListener("change", (event) => {
            togglePayoutPanels(event.target.value);
        });

        document.getElementById("upload-wechat-qr-btn").addEventListener("click", async () => {
            clearAlert();
            try {
                await uploadPayoutQr("wechat_pay");
            } catch (error) {
                showAlert(error.message || "上传微信收款码失败");
            }
        });

        document.getElementById("upload-alipay-qr-btn").addEventListener("click", async () => {
            clearAlert();
            try {
                await uploadPayoutQr("alipay");
            } catch (error) {
                showAlert(error.message || "上传支付宝收款码失败");
            }
        });

        document.getElementById("payout-form").addEventListener("submit", async (event) => {
            event.preventDefault();
            clearAlert();

            try {
                const payload = collectPayoutPayload();
                await apiRequest("/users/me/payout-info", {
                    method: "PUT",
                    body: payload,
                });
                await refreshAll();
                showAlert("收款信息已保存", "success");
            } catch (error) {
                showAlert(error.message || "保存收款信息失败");
            }
        });

        try {
            await refreshAll();
            resetSocialForm();
        } catch (error) {
            showAlert(error.message || "加载个人中心失败");
        }
    });
</script>
</body>
</html>
